openapi: 3.0.3
info:
  title: Laravel Idempotency API
  description: |
    This API implements Stripe-style idempotency for preventing duplicate requests.
    
    ## Idempotency
    
    All POST, PUT, PATCH, and DELETE requests support idempotency through the use of idempotency keys. 
    An idempotency key is a unique value generated by the client which the server uses to recognize 
    subsequent retries of the same request.
    
    ### How to use idempotency
    
    To perform an idempotent request, provide an additional `Idempotency-Key` header to the request:
    
    ```
    Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000
    ```
    
    The idempotency key should be a UUID or any unique string (max 255 characters).
    
    ### Idempotency behavior
    
    - **First request**: Processed normally, response cached
    - **Duplicate request (same key)**: Returns cached response immediately (sub-millisecond)
    - **Same key, different payload**: Returns 422 error (payload mismatch)
    - **Concurrent requests**: Second request returns 409 or waits for first to complete
    
    ### Generating idempotency keys
    
    Keys should be generated client-side using:
    - UUIDs (v4 recommended)
    - Deterministic keys based on operation (e.g., `payment-{orderId}-{timestamp}`)
    - Stored keys for retry scenarios
    
    ### Key retention
    
    Idempotency keys are retained for 24 hours by default. After this period, 
    the same key can be used for a different request.
    
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: https://staging-api.example.com/v1
    description: Staging server
  - url: http://localhost:8000/api
    description: Local development

tags:
  - name: Payments
    description: Payment processing endpoints (idempotency recommended)
  - name: Orders
    description: Order management endpoints (idempotency recommended)
  - name: Refunds
    description: Refund processing endpoints (idempotency required)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from authentication endpoint
    
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for server-to-server authentication

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema:
        type: string
        format: uuid
        maxLength: 255
        example: 550e8400-e29b-41d4-a716-446655440000
      description: |
        Unique idempotency key to prevent duplicate requests.
        Must be a UUID or unique string (max 255 characters).
        The same key with the same request will return the cached response.

  schemas:
    Error:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Human-readable error message
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Validation errors (optional)
      example:
        message: "Validation failed"
        errors:
          amount: ["The amount field is required."]

    IdempotencyError:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          enum:
            - "Idempotency-Key required"
            - "Invalid Idempotency-Key format"
            - "Payload mismatch for idempotency key"
            - "Request in progress"
      examples:
        - message: "Idempotency-Key required"
        - message: "Payload mismatch for idempotency key"

    Payment:
      type: object
      required:
        - id
        - amount
        - currency
        - status
      properties:
        id:
          type: string
          example: "pay_1234567890abcdef"
          description: Unique payment identifier
        amount:
          type: integer
          format: int64
          example: 1000
          description: Amount in smallest currency unit (cents)
        currency:
          type: string
          minLength: 3
          maxLength: 3
          example: "USD"
          description: Three-letter ISO currency code
        customer_id:
          type: string
          example: "cus_1234567890"
          description: Customer identifier
        description:
          type: string
          maxLength: 255
          nullable: true
          example: "Payment for order #12345"
        status:
          type: string
          enum:
            - pending
            - succeeded
            - failed
            - refunded
          example: "succeeded"
        created_at:
          type: string
          format: date-time
          example: "2026-01-09T12:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-01-09T12:00:05Z"

    PaymentRequest:
      type: object
      required:
        - amount
        - currency
        - customer_id
      properties:
        amount:
          type: integer
          format: int64
          minimum: 1
          example: 1000
          description: Amount in smallest currency unit (cents)
        currency:
          type: string
          minLength: 3
          maxLength: 3
          example: "USD"
          description: Three-letter ISO currency code (uppercase)
        customer_id:
          type: string
          example: "cus_1234567890"
          description: Customer identifier
        description:
          type: string
          maxLength: 255
          nullable: true
          example: "Payment for order #12345"

    Refund:
      type: object
      required:
        - id
        - payment_id
        - amount
        - status
      properties:
        id:
          type: string
          example: "ref_1234567890abcdef"
        payment_id:
          type: string
          example: "pay_1234567890abcdef"
        amount:
          type: integer
          format: int64
          example: 1000
        reason:
          type: string
          maxLength: 255
          nullable: true
          example: "requested_by_customer"
        status:
          type: string
          enum:
            - pending
            - succeeded
            - failed
          example: "succeeded"
        created_at:
          type: string
          format: date-time

    RefundRequest:
      type: object
      properties:
        amount:
          type: integer
          format: int64
          minimum: 1
          nullable: true
          example: 1000
          description: Amount to refund (optional, defaults to full amount)
        reason:
          type: string
          maxLength: 255
          nullable: true
          example: "requested_by_customer"

paths:
  /payments:
    post:
      tags:
        - Payments
      summary: Create a payment
      description: |
        Creates a new payment. This endpoint is idempotent - multiple requests with the 
        same idempotency key will return the same payment without creating duplicates.
        
        **Idempotency behavior:**
        - First request: Creates payment and returns 201
        - Duplicate request: Returns cached 201 response with same payment
        - Same key, different data: Returns 422 error
      operationId: createPayment
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequest'
            examples:
              basic:
                summary: Basic payment
                value:
                  amount: 1000
                  currency: "USD"
                  customer_id: "cus_1234567890"
              with_description:
                summary: Payment with description
                value:
                  amount: 2500
                  currency: "EUR"
                  customer_id: "cus_9876543210"
                  description: "Subscription payment for January 2026"
      responses:
        '201':
          description: Payment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
              example:
                id: "pay_1234567890abcdef"
                amount: 1000
                currency: "USD"
                customer_id: "cus_1234567890"
                description: null
                status: "pending"
                created_at: "2026-01-09T12:00:00Z"
                updated_at: "2026-01-09T12:00:00Z"
        '400':
          description: Idempotency-Key header missing or invalid format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IdempotencyError'
              examples:
                missing_key:
                  value:
                    message: "Idempotency-Key required"
                invalid_format:
                  value:
                    message: "Invalid Idempotency-Key format"
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Unauthenticated"
        '409':
          description: Request in progress (concurrent duplicate request)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IdempotencyError'
              example:
                message: "Request in progress"
        '422':
          description: Validation failed or payload mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                validation_error:
                  value:
                    message: "Validation failed"
                    errors:
                      amount: ["The amount field is required."]
                      currency: ["The currency must be 3 characters."]
                payload_mismatch:
                  value:
                    message: "Payload mismatch for idempotency key"

    get:
      tags:
        - Payments
      summary: List payments
      description: Retrieve a list of payments (read-only, no idempotency needed)
      operationId: listPayments
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of payments
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payment'
                  meta:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer

  /payments/{payment_id}:
    get:
      tags:
        - Payments
      summary: Get payment details
      description: Retrieve details of a specific payment (read-only, no idempotency needed)
      operationId: getPayment
      security:
        - BearerAuth: []
      parameters:
        - name: payment_id
          in: path
          required: true
          schema:
            type: string
          example: "pay_1234567890abcdef"
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /payments/{payment_id}/refund:
    post:
      tags:
        - Refunds
      summary: Refund a payment
      description: |
        Creates a refund for a payment. This endpoint is idempotent and **requires** 
        an idempotency key to prevent accidental duplicate refunds.
        
        **Important:** Refunds are financial operations and must always use idempotency keys.
      operationId: refundPayment
      security:
        - BearerAuth: []
      parameters:
        - name: payment_id
          in: path
          required: true
          schema:
            type: string
          example: "pay_1234567890abcdef"
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefundRequest'
            examples:
              full_refund:
                summary: Full refund (no body needed)
                value: {}
              partial_refund:
                summary: Partial refund
                value:
                  amount: 500
                  reason: "partial_refund"
      responses:
        '200':
          description: Refund created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Refund'
        '400':
          description: Idempotency-Key required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IdempotencyError'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Invalid refund request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                already_refunded:
                  value:
                    message: "Only succeeded payments can be refunded"
                amount_too_high:
                  value:
                    message: "Refund amount cannot exceed payment amount"

  /metrics:
    get:
      tags:
        - Monitoring
      summary: Prometheus metrics endpoint
      description: |
        Exposes Prometheus metrics for monitoring idempotency performance.
        This endpoint should be protected with basic authentication.
      operationId: getMetrics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Prometheus metrics in text format
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP idempotency_cache_hits_total Number of cache hits
                # TYPE idempotency_cache_hits_total counter
                idempotency_cache_hits_total{type="redis"} 1234
                idempotency_cache_hits_total{type="database"} 567
                
                # HELP idempotency_request_duration_seconds Request duration
                # TYPE idempotency_request_duration_seconds histogram
                idempotency_request_duration_seconds_bucket{status="success",le="0.005"} 1000
                idempotency_request_duration_seconds_bucket{status="success",le="0.01"} 1200

  /api/metrics/idempotency:
    get:
      tags:
        - Monitoring
      summary: Get idempotency metrics summary
      description: Returns a JSON summary of idempotency metrics
      operationId: getIdempotencyMetrics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Metrics summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  metrics:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                      cache_hits:
                        type: integer
                      cache_misses:
                        type: integer
                      locks_acquired:
                        type: integer
                      locks_failed:
                        type: integer
                      payload_mismatches:
                        type: integer
                      jobs_executed:
                        type: integer
                      jobs_skipped:
                        type: integer
                      errors:
                        type: integer
                  timestamp:
                    type: string
                    format: date-time
              example:
                metrics:
                  enabled: true
                  cache_hits: 1234
                  cache_misses: 567
                  locks_acquired: 1800
                  locks_failed: 1
                  payload_mismatches: 0
                  jobs_executed: 450
                  jobs_skipped: 12
                  errors: 0
                timestamp: "2026-01-09T12:00:00Z"
